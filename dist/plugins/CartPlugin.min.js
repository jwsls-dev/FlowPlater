var CartPlugin=function(){"use strict";const i={level:1,levels:{ERROR:0,WARN:1,INFO:2,DEBUG:3},log:function(t){this.level},error:function(...t){this.log(this.levels.ERROR,...t)},warn:function(...t){this.log(this.levels.WARN,...t)},info:function(...t){this.log(this.levels.INFO,...t)},debug:function(...t){this.log(this.levels.DEBUG,...t)}},A={INHERITABLE_ATTRIBUTES:{"hx-":["boost","push-url","select","select-oob","swap","target","vals","confirm","disable","disabled-elt","encoding","ext","headers","include","indicator","params","prompt","replace-url","request","sync","vars"],"fp-":["prepend","append","persist","target"]},_prefixes(){return Object.keys(this.INHERITABLE_ATTRIBUTES)},_normalizeAttributeName(t){return t.replace(/^(hx-|fp-)/,"").replace(/^data-/,"")},_getAllAttributeNames(t){var e=this._normalizeAttributeName(t),r=[];for(const a of this._prefixes())r.push(""+a+e),r.push("data-"+a+e);return r},_getRawAttribute(t,e,r=null){for(const l of this._getAllAttributeNames(e)){var a=t.getAttribute(l);if(null!==a)return a}return r},_hasAttribute(e,t){return this._getAllAttributeNames(t).some(t=>e.hasAttribute(t))},findMatchingElements(t,e,r=!0,a=document,l=!0,o=!1){var n=this._getAllAttributeNames(t);let i=n.map(t=>`[${t}]`).join(",");if(null!=e){const s=r?`="${e}"`:`*="${e}"`;i=n.map(t=>`[${t}${s}]`).join(",")}n=Array.from(a.querySelectorAll(i));return l&&a instanceof Element&&(null===(l=this._getRawAttribute(a,t))||null!=e&&(r?l!==e:!l.includes(e))||n.unshift(a)),null!=e&&o?n[0]:n},findClosestParent(t,e,r=!0,a){if(!t)return i.error("Attribute name is required"),null;if(!a)return i.error("Element is required to find closest parent ("+t+")"),null;var t=this._normalizeAttributeName(t),l=this._getAllAttributeNames(t);let o=l.map(t=>`[${t}]`).join(",");if(null!=e){const n=r?`="${e}"`:`*="${e}"`;o=l.map(t=>`[${t}${n}]`).join(",")}r=a.closest(o);if(r&&this.isInheritable(t)){e=this._getRawAttribute(r,"disinherit");if(e&&("*"===e||e.split(" ").includes(t)))return null}return r},getElementWithAttribute(t,e=document,r=!0){return r&&e instanceof Element&&this._hasAttribute(e,t)?e:(r=this._getAllAttributeNames(t).map(t=>`[${t}]`).join(","),e.querySelector(r))},_parentElement(t){var e=t.parentElement;return!e&&t.parentNode instanceof ShadowRoot?t.parentNode:e},_getRootNode(t,e=!1){return t.getRootNode?t.getRootNode({composed:e}):document},_getClosestMatch(t,e){for(;t&&!e(t);)t=this._parentElement(t);return t||null},_attributeMatchesNormalizedName(t,e){return t.replace(/^data-/,"").replace(/^hx-/,"").replace(/^fp-/,"")===e},_getAttributeValueWithInheritance(t,e,r){var a=this._getRawAttribute(e,r),l=this._getRawAttribute(e,"disinherit"),o=this._getRawAttribute(e,"inherit");if(t!==e){if(htmx.config.disableInheritance)return o&&("*"===o||o.split(" ").includes(r))?a:null;if(l&&("*"===l||l.split(" ").includes(r)))return"unset"}return a},findInheritedAttribute(e,t){const r=this._normalizeAttributeName(t);let a=null;return this._getClosestMatch(e,t=>{t=this._getAttributeValueWithInheritance(e,t,r);return!!t&&(a=t,!0)}),"unset"===a?null:a},findAttribute(t,e){var r=this._normalizeAttributeName(e);for(const l of this._prefixes()){var a=this._getRawAttribute(t,""+l+r);if(a)return a}return this.findInheritedAttribute(t,r)||null},_validateAttributeName(t){return t?!!this.isInheritable(t)||(i.info(`Attribute ${t} is not inheritable`),!1):(i.error("Attribute name is required"),!1)},addInheritableAttribute(t,e){this.INHERITABLE_ATTRIBUTES[t]||(this.INHERITABLE_ATTRIBUTES[t]=[]),this.INHERITABLE_ATTRIBUTES[t].push(e)},removeInheritableAttribute(t,e){return!!this.INHERITABLE_ATTRIBUTES[t]&&-1!==(e=this.INHERITABLE_ATTRIBUTES[t].indexOf(e))&&(this.INHERITABLE_ATTRIBUTES[t].splice(e,1),!0)},isInheritable(t){t=this._normalizeAttributeName(t);return Object.values(this.INHERITABLE_ATTRIBUTES).flat().includes(t)}};return(t={})=>{FlowPlater.config({storage:{enabled:!0}}),FlowPlater.log(FlowPlater.logLevels.INFO,"[CartPlugin] Early config executed: Storage enabled.");const d={name:"cart",enabled:!0,priority:50,version:"1.0.0",dependencies:["data-extractor"],optionalDependencies:[],settings:{debug:!1,dataAttribute:"product",group:"cart",requiredKeys:["id","name"]},description:"Shopping cart functionality for FlowPlater",author:"FlowPlater Team",currency:{name:"USD",symbol:"$",precision:2},taxRates:[{name:"VAT",value:1.21}]},g=(Object.assign(d,t),(t,e)=>{var r=t?.id;if(null==r)return FlowPlater.log(FlowPlater.logLevels.ERROR,"[CartPlugin] Cannot generate cart item ID: Base product ID is missing.",t),null;e=e?A._getRawAttribute(e,"cart-variant-key",null):null;if(!e)return r.toString();e=e.split(",").map(t=>t.trim()).sort();if(0===e.length)return r.toString();var a,l=[];for(const o of e)t.hasOwnProperty(o)?"string"==typeof(a=t[o])||"number"==typeof a?l.push(encodeURIComponent(o)+"="+encodeURIComponent(a)):FlowPlater.log(FlowPlater.logLevels.WARN,`[CartPlugin] Variant key '${o}' has non-primitive value, skipping for ID generation:`,a):FlowPlater.log(FlowPlater.logLevels.WARN,`[CartPlugin] Variant key '${o}' not found in product data for ID generation.`);return 0===l.length?r.toString():r+"::"+l.join(";")}),m={cart:{items:new Map,totalItems:0,totalPrice:0,totalDiscount:0,totalTax:0,totalAmount:0},observers:new Map},r=()=>{var t=Array.from(m.cart.items.values());return t.forEach(t=>{t.cartItemId||(t.cartItemId=g(t,null))}),{items:t,totalItems:m.cart.totalItems,totalPrice:m.cart.totalPrice,totalDiscount:m.cart.totalDiscount,totalTax:m.cart.totalTax,totalAmount:m.cart.totalAmount}},n=t=>{if(t){const e=new Map;Array.isArray(t.items)&&t.items.forEach(t=>{t&&void 0!==t.cartItemId?e.set(t.cartItemId,t):t&&void 0!==t.id&&(FlowPlater.log(FlowPlater.logLevels.WARN,"[CartPlugin] Cart item missing cartItemId during deserialization. Using base id as fallback key.",t),e.set(t.id,t))}),m.cart.items=e,m.cart.totalItems=t.totalItems||0,m.cart.totalPrice=t.totalPrice||0,m.cart.totalDiscount=t.totalDiscount||0,m.cart.totalTax=t.totalTax||0,m.cart.totalAmount=t.totalAmount||0,FlowPlater.log(FlowPlater.logLevels.DEBUG,"[CartPlugin] State after deserializeCart:",m.cart)}else m.cart.items=new Map,m.cart.totalItems=0,m.cart.totalPrice=0,m.cart.totalDiscount=0,m.cart.totalTax=0,m.cart.totalAmount=0,FlowPlater.log(FlowPlater.logLevels.DEBUG,"[CartPlugin] State reset in deserializeCart (no data).")},f=t=>{return A.findClosestParent("data",d.settings.dataAttribute,!0,t)},u=(t,e)=>{return e?e.endsWith("%")?t*(1-parseFloat(e)/100):Math.max(0,t-parseFloat(e)):t},c=t=>{t=m.cart.items.get(t);return t?t.amount:0},p=()=>{let o=0,n=0,i=0,s=0,e=0;m.cart.items.forEach(e=>{o+=e.amount;var t=e.price||0,r=e.discount||"0",r=u(t,r),a=r*e.amount,l=a*(d.taxRates.find(t=>t.name.toLowerCase()===e.taxRate?.toLowerCase())?.value||d.taxRates[0].value);n+=t*e.amount,i+=(t-r)*e.amount,s+=l-a}),A.findMatchingElements("data",d.settings.dataAttribute).forEach(e=>{if(e.closest(`[fp-group="${d.settings.group}"]`)){const i=v(e);void(i&&(t=Array.from(m.cart.items.values()).find(t=>t.id===i.id&&(!t.cartItemId||t.cartItemId===e.getAttribute("fp-cart-item-id"))))&&t.cartItemId&&e.setAttribute("fp-cart-item-id",t.cartItemId))}else{const i=v(e);var t,r,a,l,o,n;i&&(t=e.querySelector("[fp-cart-add]"),r=e.querySelector("[fp-cart-remove]"),a=e.querySelector("[fp-cart-item-amount]"),l=g(i,t),l=c(l),o=void 0===i.stock||null===i.stock?1/0:i.stock,n=l<=0,t&&(t.disabled=o<=l),r&&(r.disabled=n),a)&&(a.value=l,a.min="0",a.max=o)}}),e=n-i+s,m.cart.totalItems=o,m.cart.totalPrice=n,m.cart.totalDiscount=i,m.cart.totalTax=s,m.cart.totalAmount=e,A.findMatchingElements("cart-total-count").forEach(t=>{t.textContent=o.toString()}),A.findMatchingElements("cart-total-price").forEach(t=>{t.textContent=n.toFixed(2)}),A.findMatchingElements("cart-total-discount").forEach(t=>{t.textContent=i.toFixed(2)}),A.findMatchingElements("cart-total-tax").forEach(t=>{t.textContent=s.toFixed(2)}),A.findMatchingElements("cart-total-amount").forEach(t=>{t.textContent=e.toFixed(2)});var t=r();FlowPlater.updateGroup(d.settings.group,t),FlowPlater.trigger("cart:update",null,{cart:m.cart}),document.querySelectorAll(`[fp-group="${d.settings.group}"] [fp-cart-remove]`).forEach(t=>{t.disabled=!1})},h=(t,e=null)=>{t=g(t,e);t&&(m.cart.items.delete(t),p())},a=t=>{var e=d.settings,r=e.variantKey||"variant";const a=e.variantIdKey||"id";var l,e=e.variantSelectorKey||"selected-variant",o=t[r];const n=t[e];return Array.isArray(o)&&0!==o.length?"string"!=typeof n&&"number"!=typeof n?(FlowPlater.log(FlowPlater.logLevels.WARN,`[CartPlugin] Invalid or missing value for selector key '${e}'. Expected string or number, got:`,n),delete t[r],t.hasOwnProperty(e)&&delete t[e],t):(o=o.find(t=>t&&t[a]?.toString()===n.toString()))?(delete(l={...t})[r],delete l[e],Object.assign(l,o),FlowPlater.log(FlowPlater.logLevels.DEBUG,"[CartPlugin] Variant merged",{baseData:t,selectedVariant:o,mergedData:l}),l):(FlowPlater.log(FlowPlater.logLevels.WARN,`[CartPlugin] No variant found with ${a} matching selector value:`,n),delete t[r],t.hasOwnProperty(e)&&delete t[e],t):(t.hasOwnProperty(e)&&delete t[e],t)},v=t=>{FlowPlater.log(FlowPlater.logLevels.INFO,"Processing HTML",t);let e=null;try{e=FlowPlater.getPlugin("data-extractor").instanceMethods.extractData(t)}catch(t){return FlowPlater.log(FlowPlater.logLevels.ERROR,"[CartPlugin] Failed to extract data using DataExtractorPlugin.",t),null}var r;return e&&0!==Object.keys(e).length?(r=e[d.settings.dataAttribute]||e,a(r)):(FlowPlater.log(FlowPlater.logLevels.WARN,"[CartPlugin] Data extraction yielded no data.",t),null)},i=(t,e,r=null)=>{var a,l,o=g(t,r);o&&((a=m.cart.items.get(o))?(l=void 0===a.stock||null===a.stock?1/0:a.stock,0===(e=Math.min(Math.max(0,e),l))?(FlowPlater.log(FlowPlater.logLevels.DEBUG,`[CartPlugin] updateAmount: Removing item ${o} (newAmount is 0).`),h(t,r)):e!==a.amount?(FlowPlater.log(FlowPlater.logLevels.DEBUG,`[CartPlugin] updateAmount: Updating item ${o} from ${a.amount} to ${e}.`),a.amount=e,p()):FlowPlater.log(FlowPlater.logLevels.DEBUG,`[CartPlugin] updateAmount: Item ${o} amount (${a.amount}) unchanged.`)):FlowPlater.log(FlowPlater.logLevels.DEBUG,`[CartPlugin] updateAmount called for non-existent item: ${o}. No action taken.`))},s=l=>{var t;m.observers.has(l)||((t=new MutationObserver(t=>{for(const a of t){var e,r;("attributes"===a.type&&A._attributeMatchesNormalizedName(a.attributeName,"data")||"characterData"===a.type&&A._hasAttribute(a.target.parentElement,"data"))&&(e=v(l),r=m.cart.items.get(e.id))&&(Object.assign(r,e),p())}})).observe(l,{attributes:!0,attributeFilter:A._getAllAttributeNames("data"),characterData:!0,subtree:!0}),m.observers.set(l,t))};return{config:d,state:m,hooks:{initComplete:function(t,e){var r=FlowPlater.getOrCreateGroup(d.settings.group,{}),r=(r&&r.data?(FlowPlater.log(FlowPlater.logLevels.DEBUG,"[CartPlugin] Calling deserializeCart with group data:",r.data),n(r.data)):(FlowPlater.log(FlowPlater.logLevels.WARN,"[CartPlugin] No group or group data found in initComplete."),n(null)),()=>{document.querySelectorAll("[fp-cart-add], [fp-cart-remove], [fp-cart-item-amount]").forEach(t=>{t.removeEventListener("click",a),t.removeEventListener("change",l)}),document.querySelectorAll("[fp-cart-add], [fp-cart-remove]").forEach(t=>{t.addEventListener("click",a)}),document.querySelectorAll("[fp-cart-item-amount]").forEach(t=>{t.addEventListener("change",l)}),document.querySelectorAll("[fp-cart-item-amount]").forEach(t=>{t.removeEventListener("input",o),t.addEventListener("input",o)}),A.findMatchingElements("data",d.settings.dataAttribute).forEach(t=>{var e,r,a,l,o,n,i;t.closest(`[fp-group="${d.settings.group}"]`)?t.querySelectorAll("input:not([fp-cart-item-amount]), select, textarea").forEach(t=>{t.removeEventListener("change",p),t.addEventListener("change",p)}):(o=v(t),l=g(o,t.querySelector("[fp-cart-add]")),l=m.cart.items.get(l),e=t.querySelector("[fp-cart-item-amount]"),r=t.querySelector("[fp-cart-add]"),a=t.querySelector("[fp-cart-remove]"),l=l?.amount||0,n=(o=void 0===o.stock||null===o.stock?1/0:o.stock)<=l,i=l<=0,e&&(e.value=l.toString(),e.min="0",e.max=o),r&&(r.disabled=n),a&&(a.disabled=i),t.querySelectorAll("input:not([fp-cart-item-amount]), select, textarea").forEach(t=>{t.removeEventListener("change",p),t.addEventListener("change",p)}))})});const a=e=>{e.preventDefault(),e.stopPropagation();var e=e.currentTarget,r=e.hasAttribute("fp-cart-add"),t=e.hasAttribute("fp-cart-remove");if(r||t){e=f(e);if(e){var a=e.closest(`[fp-group="${d.settings.group}"]`);if(t&&a){let t=e.getAttribute("fp-data-cart-item-id");if(t||(a=v(e))&&(l=Object.keys(a).filter(t=>"id"!==t&&"amount"!==t&&"price"!==t&&"stock"!==t&&"cartItemId"!==t&&!d.settings.requiredKeys.includes(t)),(o=document.createElement("button")).setAttribute("fp-cart-variant-key",l.join(",")),t=g(a,o)),t)return FlowPlater.log(FlowPlater.logLevels.DEBUG,"[CartPlugin] Remove button clicked for cart item: "+t),m.cart.items.delete(t),void p()}var l=v(e);if(l){a=e.querySelector("[fp-cart-add]");if(r){var o=e.querySelector("[fp-cart-item-amount]");let t=1;o&&(r=parseInt(o.value),!isNaN(r))&&0<r&&(t=r);var o=g(l,a),[n,r=1,o=null]=(FlowPlater.log(FlowPlater.logLevels.DEBUG,`[CartPlugin] Add button clicked for ${o}, amount from input: `+t),[l,t,a]),i=d.settings.requiredKeys.filter(t=>!(t in n)).join(", ");if(i)FlowPlater.log(FlowPlater.logLevels.ERROR,"[CartPlugin] Product missing required fields: "+i);else{i=g(n,o);if(i){var o=m.cart.items.get(i),s=void 0===n.stock||null===n.stock?1/0:n.stock;if(o){var u=o.amount,c=Math.min(u+r,s);if(c===u)return;o.amount=c}else{u=Math.min(r,s);if(u<=0)return;m.cart.items.set(i,{...n,cartItemId:i,amount:u,taxRate:n.taxRate||d.taxRates[0].name})}p()}}}else t&&(c=g(l,a),FlowPlater.log(FlowPlater.logLevels.DEBUG,"[CartPlugin] Remove button clicked for product: "+c),h(l,a))}else FlowPlater.log(FlowPlater.logLevels.ERROR,"[CartPlugin] Could not extract product data.",{element:e})}}},l=t=>{t.preventDefault(),t.stopPropagation();var e,r,a,l,t=t.currentTarget;t.hasAttribute("fp-cart-item-amount")&&(e=f(t))&&((r=v(e))?(a=e.querySelector("[fp-cart-add]"),l=g(r,a),FlowPlater.log(FlowPlater.logLevels.DEBUG,`[CartPlugin] Input changed for ${l}, new value: `+t.value),i(r,parseInt(t.value)||0,a)):FlowPlater.log(FlowPlater.logLevels.ERROR,"[CartPlugin] Could not extract product data on change.",{element:e}))},o=t=>{var e,r,a,t=t.currentTarget;t.hasAttribute("fp-cart-item-amount")&&(r=f(t))&&(e=v(r))&&(r=r.querySelector("[fp-cart-add]"),a=g(e,r),FlowPlater.log(FlowPlater.logLevels.DEBUG,`[CartPlugin] Input changed for ${a}, new value: `+t.value),i(e,parseInt(t.value)||0,r))};return r(),FlowPlater.on("afterDomUpdate",r),A.findMatchingElements("data",d.settings.dataAttribute).forEach(s),p(),d.settings.debug&&FlowPlater.log(FlowPlater.logLevels.INFO,"[CartPlugin] Initialized successfully"),t}}}}}();
var FilterPlugin=function(){"use strict";const d={templateCache:{},instances:{},groups:{},length:0,initialized:!1,defaults:{animation:!1,debug:!1}},p={level:1,levels:{ERROR:0,WARN:1,INFO:2,DEBUG:3},log:function(e){this.level},error:function(...e){this.log(this.levels.ERROR,...e)},warn:function(...e){this.log(this.levels.WARN,...e)},info:function(...e){this.log(this.levels.INFO,...e)},debug:function(...e){this.log(this.levels.DEBUG,...e)}};class a extends Error{constructor(e,t){super(e),this.name="FlowPlaterError",this.stack=t}}const f=function(){const o=new Map;return{subscribe(e,t,r=null){return e&&"string"==typeof e||a("Invalid event name. Event name must be a non-empty string."),t&&"function"==typeof t||a(`Invalid callback for event "${e}". Callback must be a function.`),o.has(e)||o.set(e,[]),o.get(e).push({callback:t,context:r}),p.debug("Subscribed to event: "+e),()=>this.unsubscribe(e,t)},unsubscribe(e,t){var r;e&&"string"==typeof e||a("Invalid event name. Event name must be a non-empty string. If you are trying to unsubscribe from all events, use unsubscribeAll() instead."),o.has(e)&&(r=o.get(e),o.set(e,r.filter(e=>e.callback!==t)))},unsubscribeAll(){o.clear(),p.info("Cleared all event subscribers")},publish(r,a){if(o.has(r)&&(o.get(r).forEach(({callback:e,context:t})=>{try{e.call(t,a)}catch(e){p.error(`Error in event subscriber for ${r}:`,e)}}),a)&&a.instanceName){const s=a.instanceName+":"+r;o.has(s)&&o.get(s).forEach(({callback:e,context:t})=>{try{e.call(t,a)}catch(e){p.error(`Error in instance event subscriber for ${s}:`,e)}})}}}}();const m={isRestoringFormStates:!1,restoreFormStates(e,t){try{var r;this.isRestoringFormStates?p.debug("Already restoring form states, skipping"):(this.isRestoringFormStates=!0,r=e.getElementsByTagName("form"),Array.from(r).forEach(e=>this.restoreSingleFormState(e,t)))}catch(e){p.error("Error restoring form states: "+e.message)}finally{this.isRestoringFormStates=!1}},restoreSingleFormState(e,t){if(!e.id)return!1;const r=this.handleFormStorage(e,null,"load");if(!r)return p.debug("No stored state found for form: "+e.id),!1;const a=this.collectDebugInfo(e,"restore",{restoredElements:[],customVisualUpdates:[],skippedElements:[],storageType:this.shouldUseLocalStorage(e)?"localStorage":"sessionStorage"});return this.processFormElements(e,e=>{e.name in r&&(a.restoredElements.push({name:e.name,value:r[e.name]}),this.restoreElementValue(e,r[e.name]))}),p.debug("Form state restoration summary for "+e.id,{storageType:a.storageType,source:t||"unknown",restoredElements:a.restoredElements.map(e=>({name:e.name,value:e.value})),updatedCustomVisualStates:a.customVisualUpdates,skippedElements:a.skippedElements}),f.publish("formState:afterRestore",{formId:e.id,formElement:e,state:r,source:t||"unknown"}),!0},clearFormState(e){try{var t=document.getElementById(e);t&&(this.handleFormStorage(t,null,"clear"),f.publish("formState:clear",{formId:e,formElement:t}))}catch(e){p.error("Error clearing form state: "+e.message)}},collectDebugInfo(e,t,r={}){return{formId:e.id,type:t,persistenceEnabled:this.isPersistenceEnabledForElement(e),...r}},handleFormStorage(e,t,r="save"){var a=this.shouldUseLocalStorage(e),s="fp_form_"+e.id;if("save"===r)if(a){var o=e.id,n=t,l="form";if(p.debug("Storage config:",d.config?.storage),d.config?.storage?.enabled)try{var i=l?`fp_${l}_`+o:"fp_"+o;let t;try{t=JSON.parse(JSON.stringify(n))}catch(e){p.error("Failed to serialize data for localStorage: "+e.message),t={}}var c={data:t,expiry:Date.now()+6048e5};p.debug("Saving to localStorage:",{key:i,data:c}),localStorage.setItem(i,JSON.stringify(c))}catch(e){p.error("Failed to save to localStorage: "+e.message)}else p.debug("Storage is disabled, skipping save")}else sessionStorage.setItem(s,JSON.stringify(t));else if("load"===r){if(!a)return JSON.parse(sessionStorage.getItem(s));l=e.id,o="form";if(p.debug("Storage config:",d.config?.storage),!d.config?.storage?.enabled)return p.debug("Storage is disabled, skipping load"),null;try{var u,f=o?`fp_${o}_`+l:"fp_"+l,m=localStorage.getItem(f);return m?(u=JSON.parse(m)).expiry&&u.expiry<Date.now()?(p.debug("Stored item has expired: "+f),localStorage.removeItem(f),null):(p.debug("Loaded from localStorage:",{key:f,data:u}),u.data):(p.debug("No stored item found for: "+f),null)}catch(e){return p.error("Failed to load from localStorage: "+e.message),null}}else"clear"===r&&(a&&localStorage.removeItem(s),sessionStorage.removeItem(s))},processFormElements(e,t){Array.from(e.elements).forEach(e=>{e.name&&"file"!==e.type&&this.isPersistenceEnabledForElement(e)&&t(e)})},restoreElementValue(e,t){"checkbox"===e.type||"radio"===e.type?(e.checked=t,this.updateCustomVisualState(e)):e instanceof HTMLSelectElement&&e.multiple?Array.from(e.options).forEach(e=>{e.selected=t.includes(e.value)}):e.value=t},updateCustomVisualState(e){var t=e.closest("checkbox"===e.type?".w-checkbox":".w-radio");t&&(t=t.querySelector(`.w-${e.type}-input`))&&(t.checked=e.checked)},isPersistenceEnabledForElement(e){var t;return e.hasAttribute("fp-persist")?"false"!==e.getAttribute("fp-persist"):(t=e.closest("form"))&&t.hasAttribute("fp-persist")?"false"!==t.getAttribute("fp-persist"):(t=e.closest("[fp-persist]"))?"false"!==t.getAttribute("fp-persist"):!1!==d.config?.persistForm},shouldUseLocalStorage(e){return e.hasAttribute("fp-persist-local")||!0===d.config?.storage?.enabled},shouldRestoreForm(e){if(0<e.querySelectorAll('[fp-persist="true"]').length)return!0;if("FORM"===e.tagName&&e.hasAttribute("fp-persist"))return"false"!==e.getAttribute("fp-persist");var t=e.closest("form");if(t){if("false"===t.getAttribute("fp-persist"))return!1;for(const a of t.elements)if(a.name&&"file"!==a.type){var r=a.closest('[fp-persist="false"]');if(!r)return!0}}for(const s of e.getElementsByTagName("form"))if(this.shouldRestoreForm(s))return!0;return!1}};return()=>{const n={instances:new Map,formTemplates:new Map,formObservers:new Map};function p(e,t){return t.split(".").reduce((e,t)=>{if(null!=e)return e[t]},e)}function l(c,e,t){var r=e.split(".");let a=t;for(let e=0;e<r.length-1;e++)if(!(a=a[r[e]]))return;const u=a[r[r.length-1]];Array.isArray(u)&&c.querySelectorAll("[fp-filter-key][fp-filter-dynamic]").forEach(r=>{const s=r.getAttribute("fp-filter-key");var e=function(e,t){const r=new Set;return e.forEach(e=>{e=p(e,t);null!=e&&(Array.isArray(e)?e.forEach(e=>r.add(e)):r.add(e))}),Array.from(r).sort()}(u,s);if(r instanceof HTMLSelectElement){r.innerHTML='<option value="">Select tags...</option>',e.forEach(e=>{var t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)});const o=m.handleFormStorage(c,null,"load");o&&r.name&&o[r.name]&&(r.multiple?Array.from(r.options).forEach(e=>{e.selected=Array.isArray(o[r.name])&&o[r.name].includes(e.value)}):r.value=o[r.name])}else{const n=r;if(n){const l=n.children[0];if(l){var t=r.hasAttribute("fp-filter-preserve-default"),a=t?n.children[0].cloneNode(!0):null;n.innerHTML="",t&&a&&((t=a.querySelector("input"))&&"radio"===t.type&&(t.value=""),n.appendChild(a)),e.forEach(e=>{var t=l.cloneNode(!0),r=t.querySelector("input"),r=(r&&(r.value=e,r.id=s+"_"+e,r.name=s),t.querySelector("label"));function a(e,t){e.normalize();e=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:function(e){return e.textContent.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}}).nextNode();e&&(e.textContent=t)}r&&r.setAttribute("for",s+"_"+e),a(r||t,e),n.appendChild(t)});const i=m.handleFormStorage(c,null,"load");i&&s in i&&n.querySelectorAll("input").forEach(e=>{"radio"===e.type?e.checked=(e.value||"")===(i[s]||""):"checkbox"===e.type&&(e.checked=!0===i[s]||Array.isArray(i[s])&&i[s].includes(e.value))})}}}})}function i(){var e=new URLSearchParams(window.location.search);const r={};return e.forEach((e,t)=>{e.includes(",")?r[t]=e.split(",").filter(Boolean):r[t]=e}),r}function c(e,t){e.hasAttribute("fp-filter-usequery")&&(t=(e=function(e){const r=new URLSearchParams;return Object.entries(e).forEach(([e,t])=>{Array.isArray(t)?0<t.length&&r.set(e,t.join(",")):null!=t&&""!==t&&r.set(e,t)}),r.toString()}(t))?window.location.pathname+"?"+e:window.location.pathname,window.history.replaceState({},"",t))}function u(s,o){if(s&&o){let r;var e=(s.getAttribute("fp-filter-triggers")||"change").split(/[\s,]+/).filter(Boolean);const a=e=>{if(e.isTrusted){"submit"===e.type&&e.preventDefault();const a={};s.querySelectorAll("[fp-filter-key]").forEach(e=>{var t,r=e.getAttribute("fp-filter-key");r&&0!==(e=e.matches("input, select, textarea")?[e]:Array.from(e.querySelectorAll("input, select, textarea"))).length&&(e.some(e=>"checkbox"===e.type)?1<(t=e.filter(e=>"checkbox"===e.type)).length?a[r]=t.filter(e=>e.checked).map(e=>e.value):a[r]=t[0].checked:e.some(e=>"radio"===e.type)?(t=e.find(e=>e.checked),a[r]=t&&t.value||""):e.some(e=>e instanceof HTMLSelectElement&&e.multiple)?(t=e.find(e=>e instanceof HTMLSelectElement&&e.multiple),a[r]=Array.from(t.selectedOptions).map(e=>e.value)):a[r]=e[0].value)}),f.publish("formState:beforeCapture",{formId:s.id,formElement:s,state:a}),m.handleFormStorage(s,a,"save"),f.publish("formState:changed",{formId:s.id,formElement:s,state:a,changedElement:e.target}),s.hasAttribute("fp-filter-usequery")&&!s.dataset.fpFilterInitialLoad&&c(s,a),FlowPlater.log(FlowPlater.logLevels.DEBUG,"[FilterPlugin] Form state captured",{formState:a});var t,e=FlowPlater.getInstance(o);e?(t=e,clearTimeout(r),r=setTimeout(()=>{t.refresh({source:"filter"})},25)):FlowPlater.log(FlowPlater.logLevels.ERROR,"[FilterPlugin] Could not find instance for refresh",{instanceName:o,formId:s.id})}};var t=e=>{e.preventDefault(),s.reset(),m.handleFormStorage(s,{},"save"),a({isTrusted:!0,type:"reset",target:e.target})},e=(s.removeEventListener("submit",a),e.forEach(e=>{s.removeEventListener(e,a)}),s.addEventListener("submit",a),e.forEach(e=>{s.addEventListener(e,a)}),s.querySelector("[fp-filter-reset]"));e&&(e.removeEventListener("click",t),e.addEventListener("click",t)),f.subscribe("formState:loaded",e=>{if(e.formElement===s&&s.hasAttribute("fp-filter-usequery")){const a=i();a&&0<Object.keys(a).length&&(s.querySelectorAll("[fp-filter-key]").forEach(e=>{var t=e.getAttribute("fp-filter-key");if(t&&t in a){e=e.matches("input, select, textarea")?[e]:Array.from(e.querySelectorAll("input, select, textarea"));if(0!==e.length){const r=a[t];e.forEach(e=>{"checkbox"===e.type?Array.isArray(r)?e.checked=r.includes(e.value):e.checked=r:"radio"===e.type?e.checked=(e.value||"")===(r||""):e instanceof HTMLSelectElement&&e.multiple?Array.from(e.options).forEach(e=>{e.selected=Array.isArray(r)?r.includes(e.value):r===e.value}):e.value=r})}}}),(e={isTrusted:!0,type:"init",target:s}).isTrusted)&&(e=FlowPlater.getInstance(o))&&e.refresh({source:"filter"})}})}}function g(e){return e?e instanceof Date?e:(e=new Date(e),isNaN(e)?null:e):null}function o(d,e){return Object.entries(e).every(([e,t])=>{var r,a,[e,s]=e.split(":"),e=p(d,e);if(!s){if(t.some(e=>"checkbox"===e.type))return r=e,0===(a=(a=t).filter(e=>"checkbox"===e.type&&e.checked)).length||a.some(e=>{return e.value===r});if(t.some(e=>"radio"===e.type))return a=e,!(o=(o=t).find(e=>"radio"===e.type&&e.checked))||!o.value||a===o.value;{var o=t,n=e;const m=o.find(e=>"text"===e.type||"SELECT"===e.tagName);return!m||("SELECT"===m.tagName?!m.value||""===m.value||(m.multiple?0===(o=Array.from(m.selectedOptions).map(e=>e.value)).length||(Array.isArray(n)?o.some(t=>n.some(e=>e.toString().toLowerCase()===t.toLowerCase())):o.some(e=>n.toString().toLowerCase()===e.toLowerCase())):Array.isArray(n)?n.some(e=>e.toString().toLowerCase()===m.value.toLowerCase()):n.toString().toLowerCase()===m.value.toLowerCase()):!m.value||("date"===m.getAttribute("fp-filter-type")?(o=g(n),l=g(m.value),!o||!l||o.getTime()===l.getTime()):n.toString().toLowerCase().includes(m.value.toLowerCase())))}}var l=e,e=s,s=t[0].value;if(!s)return!0;if(l instanceof Date||"string"==typeof(t=l)&&(/^\d{4}-\d{2}-\d{2}/.test(t)||/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(t))){var i=g(l),c=g(s);if(!i||!c)return!0;switch(e){case"min":return c<=i;case"max":return i<=c;default:return!0}}var u=parseFloat(s),f=parseFloat(l);if(isNaN(u)||isNaN(f))return!0;switch(e){case"min":return u<=f;case"max":return f<=u;default:return!0}})}return{config:{name:"filter",enabled:!0,priority:0,version:"1.0.0",dependencies:[],optionalDependencies:[],settings:{debug:!1},description:"Filters data based on form inputs",author:"FlowPlater Team"},state:n,hooks:{updateData:function(o,e){return o&&"system"!==e?.source&&0!==(e=document.querySelectorAll(`[fp-filter-instance="${o.instanceName}"]`)).length&&e.forEach(e=>{var t=e.getAttribute("fp-filter");if(t){n.formTemplates.has(o.instanceName)||(n.formTemplates.set(o.instanceName,{formElement:e,originalHTML:e.innerHTML}),u(e,o.instanceName));var r=o.getData();if(l(e,t,r),e.hasAttribute("fp-filter-usequery")&&m.isPersistenceEnabledForElement(e)){const a=i();if(a&&0<Object.keys(a).length){e.querySelectorAll("[fp-filter-key]").forEach(e=>{var t=e.getAttribute("fp-filter-key");if(t&&t in a){e=e.matches("input, select, textarea")?[e]:Array.from(e.querySelectorAll("input, select, textarea"));if(0!==e.length){const r=a[t];e.forEach(e=>{"checkbox"===e.type?Array.isArray(r)?e.checked=r.includes(e.value):e.checked=r:"radio"===e.type?e.checked=(e.value||"")===(r||""):e instanceof HTMLSelectElement&&e.multiple?Array.from(e.options).forEach(e=>{e.selected=Array.isArray(r)?r.includes(e.value):r===e.value}):e.value=r})}}});if({isTrusted:!0,type:"init",target:e}.isTrusted){const s=FlowPlater.getInstance(s.instanceName);s&&s.refresh({source:"filter"})}}}}}),o},cleanup:function(){n.formObservers.forEach(e=>{e.disconnect()}),n.formObservers.clear(),n.formTemplates.clear()}},transformers:{transformDataBeforeRender:function(e,t,r){if(!t)return t;if("json"!==r)return FlowPlater.log(FlowPlater.logLevels.ERROR,"[FilterPlugin] Data type is not json. Skipping filter."),t;r=document.querySelectorAll(`[fp-filter-instance="${e.instanceName}"]`);if(0===r.length)return t;let a={...t};return r.forEach(e=>{var r=e.getAttribute("fp-filter");if(r){const s={};e.querySelectorAll("input, select").forEach(e=>{var t,r,a=e.getAttribute("fp-filter-key")||e.name;a&&0!==(e=e.matches("input, select")?[e]:Array.from(e.querySelectorAll("input, select"))).length&&([t,r]=a.split(":"),r=r?t+":"+r:t,s[r]||(s[r]=[]),s[r].push(...e),FlowPlater.log(FlowPlater.logLevels.DEBUG,"[FilterPlugin] Found inputs for filter key",{key:a,inputCount:e.length,inputTypes:e.map(e=>e.type)}))});e=a[r].filter(e=>o(e,s));let t=a;for(let e=0;e<r.split(".").length-1;e++)t=t[r.split(".")[e]];t[r.split(".")[r.split(".").length-1]]=e}}),a}}}}}();